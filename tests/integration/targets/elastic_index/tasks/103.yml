---
- vars:
    elastic_user: elastic
    elastic_password: secret
    elastic_port: 9200
    elastic_api_key_name: "test-api-key"

  block:

  - name: Enable api keys (should only be needed for 7, 8 defaults to enabled)
    community.elastic.elastic_cluster_settings:
      login_user: "{{ elastic_user }}"
      login_password: "{{ elastic_password }}"
      auth_method: "http_auth"
      settings:
        xpack.security.authc.api_key.enabled: "true"

  - name: Create an API key for Elasticsearch
    ansible.builtin.uri:
      url: "http://localhost:{{ elastic_port }}/_security/api_key"
      method: POST
      user: "{{ elastic_user }}"
      password: "{{ elastic_password }}"
      body_format: json
      body: |
        {
          "name": "{{ elastic_api_key_name }}",
          "expiration": "1d", 
          "role_descriptors": {}
        }
      headers:
        Content-Type: "application/json"
      return_content: yes
    register: api_key_response

  - assert:
      that:
        - api_key_response.content.name == "test-api-key"

  - name: Create an index using the api key
    community.elastic.elastic_index:
      name: myapikeyindex
      auth_method: "api_key"
      api_key: "{{ api_key_response.content.api_key }}"
    check_mode: yes
    register: result

  - assert:
      that:
        - result.msg == "The index 'myapikeyindex' was created."
        - result.changed == True